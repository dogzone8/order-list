<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Order List">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="icons/favicon-32.png">
  <link rel="manifest" href="manifest.webmanifest">
  <title>Order List</title>
  <style>
    :root {
      --bg:#f6f8fb;
      --card:#ffffff;
      --line:#d3d7df;
      --text:#111827;
      --muted:#6b7280;
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --radius:14px;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body {
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: linear-gradient(180deg,#eef3ff 0%, #f6f8fb 40%, #f6f8fb 100%);
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    button, a, input, select { touch-action: manipulation; }
    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 10px 12px 30px;
    }
    .topbar {
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 6px;
    }
    .logo {
      width:34px; height:34px; border-radius:8px;
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .logo img { width:100%; height:100%; object-fit:cover; }
    .titleblock { line-height:1.1; }
    .titleblock .t1 { font-weight:800; font-size:18px; }
    .titleblock .t2 { font-size:12px; color:var(--muted); margin-top:2px; }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
    }
    .cardhead {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 14px;
    }
    .cardhead h2 {
      margin: 4px 0 0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -.2px;
    }
    .actions {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn {
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.primary {
      background: rgba(25,118,210,.12);
      border-color: rgba(25,118,210,.25);
      color:#0b3b73;
    }
    .btn:active { transform: translateY(1px); }

    .filters {
      padding: 0 14px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip {
      border: 1px solid rgba(0,0,0,.18);
      background: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip.active {
      background: rgba(25,118,210,.12);
      border-color: rgba(25,118,210,.35);
      color:#0b3b73;
    }
    .chip small {
      font-weight:900;
      background: rgba(0,0,0,.06);
      padding: 2px 7px;
      border-radius: 999px;
      color:#111;
    }

    .table { width:100%; border-top:1px solid var(--line); }
    .row, .head {
      display:grid;
      grid-template-columns: 74px 1fr 74px 96px;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      background:#fff;
    }
    .head {
      position:sticky;
      top:0;
      z-index:5;
      background:#f8fafc;
      font-weight:900;
      color:#374151;
      padding-top:12px;
      padding-bottom:12px;
    }
    .cell-item { min-width: 0; }
    .itemname {
      font-size: 18px;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    select, input[type="number"], input[type="text"] {
      width:100%;
      font-size:16px;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.22);
      background:#fff;
    }
    input[type="number"]{ text-align:center; }
    .qtybox {
      display:grid;
      grid-template-columns: 38px 1fr 38px;
      gap:8px;
      align-items:center;
    }
    .mini {
      width:38px; height:38px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.18);
      background:#f3f4f6;
      font-weight:900;
      font-size:18px;
    }
    .mini:active { transform: translateY(1px); }
    .hidden { display:none !important; }

    .orders { padding: 14px; border-top:1px solid var(--line); }
    .orderBar {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-bottom:12px;
    }
    .orderGroup {
      border:1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      background:#fff;
    }
    .orderGroup h3 { margin: 0 0 8px; font-size: 18px; font-weight: 900; }
    .orderLine { padding: 6px 0; border-top:1px dashed rgba(0,0,0,.12); font-size: 16px; font-weight: 800; }
    .orderLine:first-of-type { border-top:none; }

    .settings { padding: 14px; border-top:1px solid var(--line); }
    .sectionTitle { font-size:16px; font-weight: 900; margin: 10px 0 8px; }
    .grid3 { display:grid; grid-template-columns: 120px 1fr 120px; gap:10px; align-items:center; }
    .grid2 { display:grid; grid-template-columns: 1fr 140px; gap:10px; align-items:center; }
    .listCard { border:1px solid rgba(0,0,0,.10); border-radius: 12px; padding: 10px; margin-top:10px; background:#fff; }
    .listRow {
      display:grid;
      grid-template-columns: 44px 1fr 120px 140px;
      gap:10px;
      align-items:center;
      padding: 8px 0;
      border-top: 1px dashed rgba(0,0,0,.12);
    }
    .listRow:first-child { border-top:none; }
    .badge {
      width:40px;height:40px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;background:#e5f1ff;color:#0b3b73;border:1px solid rgba(25,118,210,.25);
    }
    .lockline { display:flex; align-items:center; gap:8px; justify-content:flex-end; font-weight:800; color:#374151; }
    .danger { background:#ffe7e7; border-color:#ffb4b4; }

    @media (max-width: 520px) {
      .wrap { padding: 8px 10px 22px; }
      .cardhead { padding: 12px; }
      .actions { gap:8px; }
      .btn { padding: 10px 10px; border-radius: 12px; }
      .row, .head {
        grid-template-columns: 62px 1fr 62px 92px;
        gap: 8px;
        padding: 10px 12px;
      }
      .itemname { font-size: 18px; }
      .qtybox { grid-template-columns: 34px 1fr 34px; gap:6px; }
      .mini { width:34px; height:34px; border-radius: 12px; }
      select, input[type="number"], input[type="text"] { padding: 10px 8px; border-radius: 12px; }
      .grid3 { grid-template-columns: 1fr; }
      .grid2 { grid-template-columns: 1fr; }
      .listRow { grid-template-columns: 40px 1fr; }
      .lockline { justify-content:flex-start; }
    }

    /* Print (no new tab) */
    body.printing { background:#fff !important; }
    #printArea { display:none; }
    body.printing #app { display:none; }
    body.printing #printArea { display:block; padding: 18px; font-family: var(--font); color:#000; }
    @media print {
      @page { margin: 0.45in; }
      body { background:#fff !important; }
      body.printing #printArea { font-size: 20pt; }
      .pTitle { font-weight: 900; font-size: 16pt; margin-bottom: 10pt; }
      .pCols { column-count: 2; column-gap: 28pt; }
      .pVendor { break-inside: avoid; margin-bottom: 10pt; }
      .pVendor .v { font-weight: 900; font-size: 18pt; margin: 0 0 6pt; }
      .pVendor .l { margin: 0 0 4pt; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo" aria-hidden="true"><img src="icons/icon-72x72.png" alt=""></div>
    <div class="titleblock">
      <div class="t1">Order List</div>
      <div class="t2">V10 2026-01-30 (PWA Test)</div>
    </div>
  </div>

  <div id="app" class="card">
    <div class="cardhead">
      <div><h2>Î™®Î∞îÏùº Ï£ºÎ¨∏ Ïï±</h2></div>
      <div class="actions">
        <button class="btn primary" id="btnOrders">üìã Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î≥¥Í∏∞</button>
        <button class="btn" id="btnClear">üßπ ÌÅ¥Î¶¨Ïñ¥</button>
        <button class="btn" id="btnSettings">‚öôÔ∏è ÏÑ§Ï†ï</button>
      </div>
    </div>

    <div id="viewHome">
      <div class="filters" id="filters"></div>
      <div class="table">
        <div class="head">
          <div>Ï∂îÏ≤ú</div>
          <div>ÌíàÎ™©</div>
          <div>Î≤§Îçî</div>
          <div>ÏàòÎüâ</div>
        </div>
        <div id="rows"></div>
      </div>
    </div>

    <div id="viewOrders" class="hidden">
      <div class="orders">
        <div class="orderBar">
          <button class="btn" id="btnBackHome">üè† Ìôà</button>
          <button class="btn primary" id="btnPrintAll">üñ®Ô∏è ÌîÑÎ¶∞Ìä∏</button>
        </div>
        <div id="ordersList"></div>
      </div>
    </div>

    <div id="viewSettings" class="hidden">
      <div class="settings">
        <div class="orderBar" style="justify-content:flex-start">
          <button class="btn" id="btnBackHome2">üè† Ìôà</button>
        </div>

        <div class="sectionTitle">ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä</div>
        <div class="grid3">
          <select id="addPref"></select>
          <input id="addItemName" type="text" placeholder="Ïòà: Tuna Saku" />
          <select id="addOrder"></select>
        </div>
        <div style="margin-top:10px;">
          <button class="btn primary" id="btnAddItem">+ ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä</button>
        </div>

        <div class="sectionTitle" style="margin-top:18px;">Î≤§Îçî Ï∂îÍ∞Ä</div>
        <div class="grid2">
          <input id="addVendorName" type="text" placeholder="Ïòà: Mutual" />
          <input id="addVendorInitial" type="text" placeholder="Ïù¥ÎãàÏÖú (Ïòà: M)" maxlength="3" />
        </div>
        <div style="margin-top:10px;">
          <button class="btn primary" id="btnAddVendor">+ Î≤§Îçî Ï∂îÍ∞Ä</button>
        </div>

        <div class="sectionTitle" style="margin-top:18px;">Î≤§Îçî Í¥ÄÎ¶¨</div>
        <div class="listCard" id="vendorManage"></div>

        <div class="sectionTitle" style="margin-top:18px;">ÏïÑÏù¥ÌÖú Í¥ÄÎ¶¨</div>
        <div class="listCard" id="itemManage"></div>

        <div class="sectionTitle" style="margin-top:18px; color:#b91c1c;">Îç∞Ïù¥ÌÑ∞</div>
        <div class="grid2">
          <button class="btn" id="btnExport">‚¨áÔ∏è Export</button>
          <label class="btn" for="fileImport">‚¨ÜÔ∏è Import</label>
          <input id="fileImport" type="file" accept="application/json" class="hidden"/>
        </div>
        <div style="margin-top:10px;">
          <button class="btn danger" id="btnReset">üóëÔ∏è Reset</button>
        </div>
      </div>
    </div>
  </div>

  <div id="printArea"></div>
</div>

<script>
(() => {
  const APP_VERSION = "V10 2026-01-30 (PWA Test)";
  const STORAGE_KEY = "orderlist_state"; // keep stable key so upgrades keep data

  const $ = (s) => document.querySelector(s);

  const defaultState = {"meta": {"version": "V10 2026-01-30 (PWA Test)", "homeFilter": "all"}, "vendors": [{"id": "M", "name": "Mutual", "initial": "M", "locked": true}, {"id": "N", "name": "Nishimoto", "initial": "N", "locked": true}, {"id": "R", "name": "Restaurant Depot", "initial": "R", "locked": true}, {"id": "H", "name": "H Mart", "initial": "H", "locked": true}], "items": [{"id": "it1", "name": "Tuna Blue fin", "preferredVendorId": "M", "orderVendorId": "M", "qty": 0, "locked": true}, {"id": "it2", "name": "Tuna Yellow Fin", "preferredVendorId": "N", "orderVendorId": "N", "qty": 0, "locked": true}, {"id": "it3", "name": "Ground Tuna", "preferredVendorId": "N", "orderVendorId": "N", "qty": 0, "locked": true}, {"id": "it4", "name": "Escolar", "preferredVendorId": "N", "orderVendorId": "N", "qty": 0, "locked": true}, {"id": "it5", "name": "Smoked Salmon", "preferredVendorId": "N", "orderVendorId": "N", "qty": 0, "locked": true}, {"id": "it6", "name": "Unagi", "preferredVendorId": "M", "orderVendorId": "M", "qty": 0, "locked": true}, {"id": "it7", "name": "Sushi Ebi", "preferredVendorId": "M", "orderVendorId": "M", "qty": 0, "locked": true}, {"id": "it8", "name": "Octopus", "preferredVendorId": "M", "orderVendorId": "M", "qty": 0, "locked": true}]};
  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return structuredClone(defaultState);
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.items) || !Array.isArray(parsed.vendors)) return structuredClone(defaultState);
      parsed.meta = parsed.meta || {};
      parsed.meta.version = APP_VERSION;
      parsed.meta.homeFilter = parsed.meta.homeFilter || "all";
      return parsed;
    } catch (e) {
      return structuredClone(defaultState);
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // View switching
  const viewHome = $("#viewHome");
  const viewOrders = $("#viewOrders");
  const viewSettings = $("#viewSettings");

  function showView(name) {
    viewHome.classList.toggle("hidden", name !== "home");
    viewOrders.classList.toggle("hidden", name !== "orders");
    viewSettings.classList.toggle("hidden", name !== "settings");
    if (name === "home") renderHome();
    if (name === "orders") renderOrders();
    if (name === "settings") renderSettings();
  }

  $("#btnOrders").addEventListener("click", () => showView("orders"));
  $("#btnSettings").addEventListener("click", () => showView("settings"));
  $("#btnBackHome").addEventListener("click", () => showView("home"));
  $("#btnBackHome2").addEventListener("click", () => showView("home"));

  $("#btnClear").addEventListener("click", () => {
    if (!confirm("ÏàòÎüâÏùÑ Ï†ÑÎ∂Ä 0ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;
    state.items.forEach(it => it.qty = 0);
    saveState();
    renderHome();
    alert("ÏôÑÎ£å!");
  });

  // Helpers
  function vendorById(id) {
    return state.vendors.find(v => v.id === id) || null;
  }
  function vendorDisplay(id) {
    const v = vendorById(id);
    return v ? v.initial : "‚Äî";
  }
  function assignedVendorId(item) {
    return item.orderVendorId || item.preferredVendorId || "";
  }
  function clampQty(x) {
    const n = Number(x);
    if (!isFinite(n) || n < 0) return 0;
    return Math.round(n * 2) / 2;
  }

  // Filters
  function renderFilters() {
    const el = $("#filters");
    el.innerHTML = "";

    const chipAll = document.createElement("div");
    chipAll.className = "chip" + ((state.meta.homeFilter || "all") === "all" ? " active" : "");
    chipAll.innerHTML = `All <small>${state.items.length}</small>`;
    chipAll.onclick = () => { state.meta.homeFilter = "all"; saveState(); renderHome(); };
    el.appendChild(chipAll);

    state.vendors.forEach(v => {
      const cnt = state.items.filter(it => assignedVendorId(it) === v.id).length;
      const chip = document.createElement("div");
      chip.className = "chip" + ((state.meta.homeFilter || "all") === v.id ? " active" : "");
      chip.innerHTML = `${v.initial} <small>${cnt}</small>`;
      chip.onclick = () => { state.meta.homeFilter = v.id; saveState(); renderHome(); };
      el.appendChild(chip);
    });
  }

  // Home
  function renderHome() {
    renderFilters();
    const rows = $("#rows");
    rows.innerHTML = "";

    const filter = state.meta.homeFilter || "all";
    const list = (filter === "all") ? state.items : state.items.filter(it => assignedVendorId(it) === filter);

    const vendorOptions = `<option value="">‚Äî</option>` + state.vendors.map(v => `<option value="${v.id}">${v.initial}</option>`).join("");

    list.forEach(it => {
      const row = document.createElement("div");
      row.className = "row";

      // Pref
      const pref = document.createElement("div");
      const prefSel = document.createElement("select");
      prefSel.innerHTML = vendorOptions;
      prefSel.value = it.preferredVendorId || "";
      prefSel.onchange = () => {
        it.preferredVendorId = prefSel.value || "";
        if (!it.orderVendorId) it.orderVendorId = it.preferredVendorId || "";
        saveState();
        renderFilters();
      };
      pref.appendChild(prefSel);

      // Item
      const itemCell = document.createElement("div");
      itemCell.className = "cell-item";
      const name = document.createElement("div");
      name.className = "itemname";
      name.textContent = it.name;
      name.title = it.name;
      itemCell.appendChild(name);

      // Order vendor
      const ord = document.createElement("div");
      const ordSel = document.createElement("select");
      ordSel.innerHTML = vendorOptions;
      ordSel.value = it.orderVendorId || "";
      ordSel.onchange = () => {
        it.orderVendorId = ordSel.value || "";
        saveState();
        renderFilters();
        if (filter !== "all") renderHome();
      };
      ord.appendChild(ordSel);

      // Qty
      const qty = document.createElement("div");
      const qb = document.createElement("div");
      qb.className = "qtybox";
      const bMinus = document.createElement("button");
      bMinus.className = "mini";
      bMinus.textContent = "‚àí";
      const inp = document.createElement("input");
      inp.type = "number";
      inp.step = "0.5";
      inp.min = "0";
      inp.value = String(it.qty ?? 0);
      const bPlus = document.createElement("button");
      bPlus.className = "mini";
      bPlus.textContent = "+";

      bMinus.onclick = () => { it.qty = clampQty((it.qty || 0) - 0.5); inp.value = it.qty; saveState(); };
      bPlus.onclick = () => { it.qty = clampQty((it.qty || 0) + 0.5); inp.value = it.qty; saveState(); };
      inp.onchange = () => { it.qty = clampQty(inp.value); inp.value = it.qty; saveState(); };

      qb.appendChild(bMinus);
      qb.appendChild(inp);
      qb.appendChild(bPlus);
      qty.appendChild(qb);

      row.appendChild(pref);
      row.appendChild(itemCell);
      row.appendChild(ord);
      row.appendChild(qty);
      rows.appendChild(row);
    });
  }

  // Orders
  function escapeHtml(s) {
    return String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
  }

  function renderOrders() {
    const listEl = $("#ordersList");
    listEl.innerHTML = "";
    const groups = new Map();

    state.items.forEach(it => {
      const q = clampQty(it.qty || 0);
      if (q <= 0) return;
      const vid = assignedVendorId(it);
      if (!vid) return;
      if (!groups.has(vid)) groups.set(vid, []);
      groups.get(vid).push({ name: it.name, qty: q });
    });

    if (groups.size === 0) {
      const empty = document.createElement("div");
      empty.style.color = "var(--muted)";
      empty.style.fontWeight = "800";
      empty.textContent = "Ï£ºÎ¨∏Ìï† ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§. (ÏàòÎüâ > 0)";
      listEl.appendChild(empty);
      return;
    }

    state.vendors.forEach(v => {
      if (!groups.has(v.id)) return;
      const box = document.createElement("div");
      box.className = "orderGroup";
      const h = document.createElement("h3");
      h.textContent = v.initial;
      box.appendChild(h);
      groups.get(v.id).forEach(line => {
        const d = document.createElement("div");
        d.className = "orderLine";
        d.textContent = `${line.name} x ${line.qty}`;
        box.appendChild(d);
      });
      listEl.appendChild(box);
    });
  }

  function buildPrintHTML() {
    const dt = new Date();
    const stamp = dt.toLocaleString();
    const groups = new Map();
    state.items.forEach(it => {
      const q = clampQty(it.qty || 0);
      if (q <= 0) return;
      const vid = assignedVendorId(it);
      if (!vid) return;
      if (!groups.has(vid)) groups.set(vid, []);
      groups.get(vid).push({ name: it.name, qty: q });
    });

    const parts = [];
    parts.push(`<div class="pTitle">Order ‚Äî All Vendors ‚Ä¢ ${stamp}</div>`);
    parts.push(`<div class="pCols">`);
    state.vendors.forEach(v => {
      if (!groups.has(v.id)) return;
      parts.push(`<div class="pVendor"><div class="v">${v.initial}</div>`);
      groups.get(v.id).forEach(l => {
        parts.push(`<div class="l">${escapeHtml(l.name)} x ${l.qty}</div>`);
      });
      parts.push(`</div>`);
    });
    parts.push(`</div>`);
    return parts.join("");
  }

  $("#btnPrintAll").addEventListener("click", () => {
    $("#printArea").innerHTML = buildPrintHTML();
    document.body.classList.add("printing");
    setTimeout(() => window.print(), 80);
  });

  window.addEventListener("afterprint", () => {
    document.body.classList.remove("printing");
    $("#printArea").innerHTML = "";
  });

  // Settings
  function fillVendorSelect(sel) {
    sel.innerHTML = `<option value="">‚Äî</option>` + state.vendors.map(v => `<option value="${v.id}">${v.initial} (${escapeHtml(v.name)})</option>`).join("");
  }

  function renderSettings() {
    fillVendorSelect($("#addPref"));
    fillVendorSelect($("#addOrder"));
    renderVendorManage();
    renderItemManage();
  }

  $("#btnAddVendor").addEventListener("click", () => {
    const name = $("#addVendorName").value.trim();
    let initial = $("#addVendorInitial").value.trim().toUpperCase();
    if (!name) return alert("Vendor nameÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    if (!initial) initial = name.trim().charAt(0).toUpperCase();
    initial = initial.substring(0, 3);

    let id = initial.charAt(0) || "V";
    const baseId = id;
    let k = 1;
    while (state.vendors.some(v => v.id === id)) { k += 1; id = baseId + k; }

    state.vendors.push({ id, name, initial: initial.charAt(0), locked: true });
    $("#addVendorName").value = "";
    $("#addVendorInitial").value = "";
    saveState();
    renderSettings();
    renderHome();
  });

  $("#btnAddItem").addEventListener("click", () => {
    const name = $("#addItemName").value.trim();
    if (!name) return alert("Item nameÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
    const pref = $("#addPref").value || "";
    const ord = $("#addOrder").value || pref || "";
    const id = "it" + Math.random().toString(16).slice(2);
    state.items.push({ id, name, preferredVendorId: pref, orderVendorId: ord, qty: 0, locked: true });
    $("#addItemName").value = "";
    saveState();
    renderSettings();
    renderHome();
  });

  function renderVendorManage() {
    const box = $("#vendorManage");
    box.innerHTML = "";
    state.vendors.forEach((v, idx) => {
      const row = document.createElement("div");
      row.className = "listRow";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = v.initial;
      row.appendChild(badge);

      const name = document.createElement("input");
      name.type = "text";
      name.value = v.name;
      name.disabled = !!v.locked;
      name.onchange = () => { v.name = name.value.trim() || v.name; saveState(); renderHome(); };
      row.appendChild(name);

      const init = document.createElement("input");
      init.type = "text";
      init.maxLength = 3;
      init.value = v.initial;
      init.disabled = !!v.locked;
      init.onchange = () => { v.initial = (init.value.trim().toUpperCase() || v.initial).charAt(0); badge.textContent = v.initial; saveState(); renderHome(); };
      row.appendChild(init);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.justifyContent = "flex-end";

      const up = document.createElement("button");
      up.className = "btn";
      up.textContent = "‚¨ÜÔ∏è";
      up.onclick = () => {
        if (idx === 0) return;
        [state.vendors[idx - 1], state.vendors[idx]] = [state.vendors[idx], state.vendors[idx - 1]];
        saveState(); renderSettings(); renderHome();
      };

      const down = document.createElement("button");
      down.className = "btn";
      down.textContent = "‚¨áÔ∏è";
      down.onclick = () => {
        if (idx === state.vendors.length - 1) return;
        [state.vendors[idx + 1], state.vendors[idx]] = [state.vendors[idx], state.vendors[idx + 1]];
        saveState(); renderSettings(); renderHome();
      };

      const del = document.createElement("button");
      del.className = "btn danger";
      del.textContent = "Delete";
      del.disabled = !!v.locked;
      del.onclick = () => {
        if (!confirm(`Delete vendor "${v.name}"?`)) return;
        const vid = v.id;
        state.items.forEach(it => {
          if (it.preferredVendorId === vid) it.preferredVendorId = "";
          if (it.orderVendorId === vid) it.orderVendorId = "";
        });
        state.vendors = state.vendors.filter(x => x.id !== vid);
        if (state.meta.homeFilter === vid) state.meta.homeFilter = "all";
        saveState(); renderSettings(); renderHome();
      };

      const lock = document.createElement("label");
      lock.className = "lockline";
      lock.innerHTML = `<input type="checkbox" ${v.locked ? "checked" : ""} /> Lock (edit/delete)`;
      lock.querySelector("input").onchange = (e) => { v.locked = e.target.checked; saveState(); renderSettings(); };

      right.appendChild(up);
      right.appendChild(down);
      right.appendChild(del);
      right.appendChild(lock);

      row.appendChild(right);
      box.appendChild(row);
    });
  }

  function renderItemManage() {
    const box = $("#itemManage");
    box.innerHTML = "";

    const vendorSelectHTML = `<option value="">‚Äî</option>` + state.vendors.map(v => `<option value="${v.id}">${v.initial}</option>`).join("");

    state.items.forEach((it, idx) => {
      const row = document.createElement("div");
      row.className = "listRow";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = vendorDisplay(it.preferredVendorId || "");
      row.appendChild(badge);

      const name = document.createElement("input");
      name.type = "text";
      name.value = it.name;
      name.disabled = !!it.locked;
      name.onchange = () => { it.name = name.value.trim() || it.name; saveState(); renderHome(); };
      row.appendChild(name);

      const ord = document.createElement("select");
      ord.innerHTML = vendorSelectHTML;
      ord.value = it.orderVendorId || "";
      ord.disabled = !!it.locked;
      ord.onchange = () => { it.orderVendorId = ord.value || ""; saveState(); renderHome(); };
      row.appendChild(ord);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.justifyContent = "flex-end";

      const up = document.createElement("button");
      up.className = "btn";
      up.textContent = "‚¨ÜÔ∏è";
      up.onclick = () => {
        if (idx === 0) return;
        [state.items[idx - 1], state.items[idx]] = [state.items[idx], state.items[idx - 1]];
        saveState(); renderSettings(); renderHome();
      };

      const down = document.createElement("button");
      down.className = "btn";
      down.textContent = "‚¨áÔ∏è";
      down.onclick = () => {
        if (idx === state.items.length - 1) return;
        [state.items[idx + 1], state.items[idx]] = [state.items[idx], state.items[idx + 1]];
        saveState(); renderSettings(); renderHome();
      };

      const del = document.createElement("button");
      del.className = "btn danger";
      del.textContent = "Delete";
      del.disabled = !!it.locked;
      del.onclick = () => {
        if (!confirm(`Delete item "${it.name}"?`)) return;
        state.items = state.items.filter(x => x.id !== it.id);
        saveState(); renderSettings(); renderHome();
      };

      const lock = document.createElement("label");
      lock.className = "lockline";
      lock.innerHTML = `<input type="checkbox" ${it.locked ? "checked" : ""} /> Lock (edit/delete)`;
      lock.querySelector("input").onchange = (e) => { it.locked = e.target.checked; saveState(); renderSettings(); };

      right.appendChild(up);
      right.appendChild(down);
      right.appendChild(del);
      right.appendChild(lock);

      row.appendChild(right);
      box.appendChild(row);
    });
  }

  // Export / Import / Reset
  $("#btnExport").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "OrderList_" + APP_VERSION.replace(/\s+/g, "_") + ".json";
    a.click();
    URL.revokeObjectURL(url);
  });

  $("#fileImport").addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      if (!parsed || !Array.isArray(parsed.items) || !Array.isArray(parsed.vendors)) throw new Error("bad");
      parsed.meta = parsed.meta || {};
      parsed.meta.version = APP_VERSION;
      parsed.meta.homeFilter = parsed.meta.homeFilter || "all";
      state = parsed;
      saveState();
      renderHome();
      alert("Import ÏôÑÎ£å!");
      showView("home");
    } catch (err) {
      alert("Import Ïã§Ìå® (JSON ÌôïÏù∏)");
    } finally {
      e.target.value = "";
    }
  });

  $("#btnReset").addEventListener("click", () => {
    if (!confirm("Reset ALL data?")) return;
    state = structuredClone(defaultState);
    saveState();
    renderHome();
    alert("Reset ÏôÑÎ£å!");
    showView("home");
  });

  // PWA SW
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // Extra double-tap zoom guard
  let lastTouchEnd = 0;
  document.addEventListener("touchend", (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, { passive: false });

  showView("home");
})();
</script>
</body>
</html>
