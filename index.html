<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Order List ‚Äî V6 2026-01-30 (PWA Final)</title>
  <style>
:root{
  --bg:#0b1220;
  --panel:#101a2e;
  --card:#0f1a31;
  --text:#e9eefb;
  --muted:#a8b3d7;
  --border:rgba(255,255,255,.10);
  --primary:#3b82f6;
  --danger:#ef4444;
  --ok:#22c55e;

  --radius:16px;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --pad: 14px;
  --max: 980px;
  --tap: 46px;
  --font: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--font);
  background: radial-gradient(1200px 700px at 20% -10%, rgba(59,130,246,.25), transparent 55%),
              radial-gradient(900px 600px at 90% 0%, rgba(34,197,94,.18), transparent 60%),
              var(--bg);
  color:var(--text);
}

a{color:inherit}

.topbar{
  position:sticky;
  top:0;
  z-index:10;
  background: rgba(11,18,32,.9);
  backdrop-filter: blur(12px);
  border-bottom:1px solid var(--border);
  padding: 10px calc(env(safe-area-inset-right) + 12px) 10px calc(env(safe-area-inset-left) + 12px);
  display:flex;
  gap: 12px;
  align-items:center;
  justify-content:space-between;
}

.brand{display:flex;align-items:center;gap:10px;min-width:240px}
.brand__icon{font-size:26px}
.brand__title{font-weight:800; letter-spacing:.2px}
.brand__sub{font-size:12px;color:var(--muted);margin-top:2px}

.topbar__actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

.container{
  max-width: var(--max);
  margin: 14px auto 70px;
  padding: 0 12px calc(env(safe-area-inset-bottom) + 20px);
}

.tabs{
  display:flex;
  gap:8px;
  padding: 10px 12px;
  max-width: var(--max);
  margin: 0 auto;
  position: sticky;
  top: 60px;
  z-index: 9;
  background: rgba(11,18,32,.8);
  backdrop-filter: blur(12px);
  border-bottom:1px solid var(--border);
}

.tab{
  flex:1;
  height: var(--tap);
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight:700;
  cursor:pointer;
}
.tab.is-active{
  background: rgba(59,130,246,.22);
  border-color: rgba(59,130,246,.55);
}

.panel{
  display:none;
  background: rgba(16,26,46,.55);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: var(--pad);
}
.panel.is-active{display:block}

.panel__header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.panel__title{font-weight:900}

.hint{
  color: var(--muted);
  font-size: 13px;
  line-height: 1.35;
  border: 1px dashed rgba(255,255,255,.18);
  background: rgba(255,255,255,.03);
  border-radius: 12px;
  padding: 10px;
  margin: 8px 0 12px;
}

.list{display:flex;flex-direction:column;gap:10px}

.card{
  background: rgba(15,26,49,.70);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
}

.row{display:flex;align-items:center}
.wrap{flex-wrap:wrap}
.between{justify-content:space-between}
.gap-xs{gap:6px}
.gap-sm{gap:10px}
.grow{flex:1}
.center{align-items:center}

.btn{
  height: var(--tap);
  padding: 0 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.06);
  color: var(--text);
  font-weight:800;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  user-select:none;
}
.btn:active{transform: translateY(1px)}
.btn--primary{
  background: rgba(59,130,246,.28);
  border-color: rgba(59,130,246,.60);
}
.btn--danger{
  background: rgba(239,68,68,.22);
  border-color: rgba(239,68,68,.55);
}
.btn--ghost{
  background: rgba(255,255,255,.03);
}
.btn--ok{
  background: rgba(34,197,94,.20);
  border-color: rgba(34,197,94,.55);
}

.fileLabel{position:relative; overflow:hidden}
.fileLabel input{
  position:absolute;
  left:-9999px;
}

.input, select{
  height: var(--tap);
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  color: var(--text);
  padding: 0 12px;
  outline:none;
  width: 100%;
}
select{cursor:pointer}

.small{
  font-size: 12px;
  color: var(--muted);
}

.badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height: 26px;
  padding: 0 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  font-weight:800;
}
.badge--ok{border-color: rgba(34,197,94,.6); background: rgba(34,197,94,.16)}
.badge--primary{border-color: rgba(59,130,246,.6); background: rgba(59,130,246,.16)}

.itemGrid{
  display:grid;
  grid-template-columns: 1.35fr .95fr .95fr 1.1fr;
  gap: 10px;
  align-items: end;
}
@media (max-width: 820px){
  .itemGrid{grid-template-columns: 1fr; gap: 10px}
}

.qtyBox{
  display:flex;
  gap: 8px;
  align-items:center;
  justify-content:flex-start;
}
.qtyValue{
  min-width: 86px;
  text-align:center;
  height: var(--tap);
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 900;
  font-size: 16px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  flex-wrap:wrap;
}

.iconBtn{
  width: var(--tap);
  min-width: var(--tap);
  padding:0;
}

.sep{
  height:1px;
  background: var(--border);
  margin: 10px 0;
}

.selectBox{
  display:flex;
  flex-wrap:wrap;
  gap: 8px;
  margin: 8px 0 12px;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
}
.check{
  display:flex; align-items:center; gap:8px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
}
.check input{width:18px;height:18px}

.orders{display:flex;flex-direction:column;gap:12px}

.vendorCard__head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 8px;
}
.vendorTitle{
  display:flex; flex-direction:column; gap:2px;
}
.vendorTitle .big{font-weight: 950}
.vendorTitle .sub{font-size:12px;color:var(--muted)}
.orderList{display:flex;flex-direction:column;gap:8px}
.orderLine{
  display:flex; justify-content:space-between; gap:10px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  border-radius: 12px;
  padding: 10px;
}
.orderLine .name{font-weight:800}
.orderLine .qty{font-weight:950}

.footer{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
  border-top: 1px solid var(--border);
  background: rgba(11,18,32,.85);
  backdrop-filter: blur(12px);
  color: var(--muted);
  font-size: 12px;
}

.toast{
  position:fixed;
  left:50%;
  transform: translateX(-50%);
  bottom: calc(env(safe-area-inset-bottom) + 80px);
  background: rgba(0,0,0,.75);
  border: 1px solid rgba(255,255,255,.15);
  color: white;
  padding: 10px 12px;
  border-radius: 12px;
  display:none;
  max-width: calc(100% - 24px);
  text-align:center;
  z-index: 999;
}

/* Print styles are in the print window, but keep this safe */
@media print{
  body{background:white;color:black}
  .topbar,.tabs,.footer{display:none!important}
  .panel{box-shadow:none}
}


/* --- V9: settings edit + lock + vendor reorder --- */
.tableWrap{overflow:auto;border:1px solid var(--border);border-radius:var(--radius);background:rgba(15,26,49,.55);}
.table{min-width:540px;width:100%;border-collapse:collapse;}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px 10px;vertical-align:middle;}
.table th{position:sticky;top:0;background:rgba(11,18,32,.92);backdrop-filter:blur(10px);z-index:1;font-size:13px;color:var(--muted);text-align:left;}
.colVendor{width:70px;}
.colQty{width:132px;}
.vendorSel{width:60px;height:42px;padding:0 10px;border-radius:12px;text-align:center;}
.itemCell{font-weight:800;min-width:240px;}
.qtyCtl{display:flex;align-items:center;gap:8px;}

/* Home items layout (no horizontal scroll on mobile) */
.itemsGrid{display:flex;flex-direction:column;gap:10px;}
.itemsHeader{display:grid;grid-template-columns:70px 1fr 70px 132px;gap:10px;padding:0 10px;color:var(--muted);font-size:13px;font-weight:700;}
.itemRow{display:grid;grid-template-columns:64px 1fr 64px 124px;gap:10px;align-items:center;background:#ffffff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px;}
.itemRow .itemCell{font-weight:800;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.itemRow .qtyCtl{justify-content:flex-end;}
@media (max-width:560px){
  .itemsHeader{grid-template-columns:46px 1fr 46px 96px;gap:6px;padding:0 6px;font-size:12px;}
  .itemRow{grid-template-columns:46px 1fr 46px 96px;gap:6px;padding:8px;border-radius:12px;}
  .vendorSel{width:42px;height:36px;padding:0 4px;border-radius:10px;}
  .qtyBtn{width:32px;height:32px;padding:0;border-radius:10px;}
  .qtyVal{min-width:26px;font-size:16px;}
  .itemRow .itemCell{font-size:17px;}
}
.qtyBtn{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;}
.qtyVal{min-width:44px;text-align:center;font-weight:900;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);padding:8px 10px;border-radius:12px;}
.quickbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.quickbar .btn{height:44px}
.footer{display:none;}
.lockTag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-size:12px;color:var(--muted);}
.lockTag input{transform:scale(1.15);}
.smallBtnRow{display:flex;gap:8px;flex-wrap:wrap}
@media (max-width: 820px){
  .table{min-width:540px;}
  .colVendor{width:66px;}
  .colQty{width:128px;}
  .vendorSel{width:56px;}
  .qtyBtn{width:36px;height:36px}
  .qtyVal{min-width:42px}
}
/* --- V15: remove top tabs/header actions, add spacing --- */
.topbar__actions{display:none !important;}
.container{padding-top:14px;}

/* ===== V16: Light theme refresh ===== */
:root{
  --bg:#f4f7ff;
  --panel:#ffffff;
  --card:#ffffff;
  --text:#0b1220;
  --muted:#475569;
  --border:rgba(15,23,42,.12);
  --primary:#2563eb;
  --danger:#dc2626;
  --ok:#16a34a;
  --shadow: 0 10px 25px rgba(15,23,42,.12);
}
body{
  background: radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,.10), transparent 55%),
              radial-gradient(900px 600px at 90% 0%, rgba(22,163,74,.08), transparent 60%),
              var(--bg);
}
.topbar{
  background: rgba(255,255,255,.88);
  border-bottom:1px solid var(--border);
}
.brand__sub{color:var(--muted);}
.panel,.card{
  background: rgba(255,255,255,.92) !important;
  color: var(--text);
}
.card{box-shadow: var(--shadow);}
.btn.btn--ghost{background: rgba(15,23,42,.04);}
.btn.btn--ghost:hover{background: rgba(15,23,42,.07);}
.btn.btn--primary{box-shadow: 0 10px 20px rgba(37,99,235,.18);}
/* Selects: reduce glare + improve readability */
select{
  background: rgba(15,23,42,.05) !important;
  color: var(--text) !important;
  border: 1px solid rgba(15,23,42,.18) !important;
}
select:focus{outline: 2px solid rgba(37,99,235,.25);}
option{color:#0b1220;background:#fff;}

/* ===== V17 tweaks: white selects for ordering ===== */
select{
  background:#ffffff !important;
  color:#0b1220 !important;
  border:1px solid rgba(15,23,42,.18) !important;
}
select:hover{border-color: rgba(37,99,235,.35) !important;}
.vendorSel{background:#ffffff !important;color:#0b1220 !important;}

/* ===== V18: Orders page light-blue surfaces ===== */
#tab-orders .card,
#tab-orders .selectBox,
#tab-orders .orders .card,
#tab-orders .vendorCard,
#tab-orders .orderCard,
#tab-orders .orders > div{
  background: rgba(37,99,235,.06) !important;
}
#tab-orders .orderLine{
  background: rgba(37,99,235,.08) !important;
  border-color: rgba(37,99,235,.18) !important;
}
#tab-orders .panel__header{
  background: transparent !important;
}

/* ===== V19: Make Home + Orders surfaces white ===== */

/* Home (Items) table background was dark/gray */
#tab-items .tableWrap{
  background:#ffffff !important;
  border-color: rgba(15,23,42,.12) !important;
}
#tab-items .table th{
  background:#f8fafc !important;
  color:#334155 !important;
  border-bottom: 1px solid rgba(15,23,42,.10) !important;
  backdrop-filter:none !important;
}
#tab-items .table td{
  border-bottom: 1px solid rgba(15,23,42,.08) !important;
}
#tab-items .table th, #tab-items .table td{
  color:#0b1220 !important;
}

/* Orders page should be plain white (not blue/gray) */
#tab-orders .selectBox,
#tab-orders .orders,
#tab-orders .orders .card,
#tab-orders .vendorCard,
#tab-orders .orderCard,
#tab-orders .card{
  background:#ffffff !important;
}
#tab-orders .orderLine{
  background:#ffffff !important;
  border-color: rgba(15,23,42,.12) !important;
}

/* V29: Home vendor quick filter */
.quickVendors{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 12px 0;}
.quickVendors .chip{padding:8px 12px;border:1px solid rgba(0,0,0,.15);border-radius:999px;background:#fff;font-weight:800;cursor:pointer;}
.quickVendors .chip.active{border-color:rgba(37,99,235,.55);background:rgba(37,99,235,.10);}
.quickVendors .chip small{font-weight:700;opacity:.65;margin-left:6px;}







  </style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Order List">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

<style>
@media print {
  html, body { font-size: 130% !important; }
  * { box-shadow: none !important; }
}
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__icon">üì¶</div>
      <div class="brand__text">
        <div class="brand__title">Order List</div>
        <div class="brand__sub">V6 2026-01-30 (PWA Final)</div>
      </div>
    </div>

    <div class="topbar__actions"></div>
  </header>

  <main class="container">
    <!-- ITEMS -->
    <section id="tab-items" class="panel is-active">
      <div class="panel__header">
        <div class="panel__title">Mobile Order App</div>
        <div class="quickbar">
          <button id="btnGoOrders" class="btn btn--primary" type="button">üìã View Orders</button>
          <button id="btnResetQty" class="btn btn--ghost" type="button">üßπ Clear Qty</button>
          <button id="btnGoSettings" class="btn btn--ghost" type="button">‚öôÔ∏è Settings</button>
        </div>
      </div>

      <div id="homeVendorQuick" class="quickVendors"></div>
      <div id="itemsList" class="list"></div>
    </section>

    <!-- ORDERS -->
    <section id="tab-orders" class="panel">
      <div class="panel__header">
        <div class="panel__title"></div>
        <div class="row gap-sm">
          <button id="btnBackHomeFromOrders" class="btn btn--ghost" type="button">üè† Home</button>
          <button id="btnPrintSelected" class="btn btn--primary" type="button">Print Selected</button>
          <button id="btnPrintAll" class="btn btn--ghost" type="button">Print All</button>
        </div>
      </div>
      <div id="vendorSelectBox" class="selectBox"></div>
      <div id="ordersView" class="orders"></div>
    </section>

    <!-- VENDORS VIEW -->
    <!-- SETTINGS -->
    <section id="tab-settings" class="panel">
      <div class="row gap-sm" style="margin-bottom:10px;"><button id="btnBackHomeFromSettings" class="btn btn--ghost" type="button">üè† Home</button></div>
      <div class="panel__header">
        <div class="panel__title">Settings</div>
      </div>

      <div class="card">
        <div class="row between wrap gap-sm">
          <div style="font-weight:900">Add Item</div>
          <div class="small">New items/vendors default to 'Lock (edit/delete) ON'</div>
        </div>
        <div class="sep"></div>
        <div class="itemGrid">
          <div>
            <div class="small">Preferred (1 letter)</div>
            <select id="setAddPrefVendor"></select>
          </div>
          <div>
            <div class="small">Item name</div>
            <input id="setAddItemName" class="input" placeholder="e.g., Tuna Saku" />
          </div>
          <div>
            <div class="small">Order (1 letter)</div>
            <select id="setAddOrderVendor"></select>
          </div>
          <div>
            <div class="small">&nbsp;</div>
            <button id="btnSettingsAddItem" class="btn btn--primary" type="button">+ Add Item</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row between wrap gap-sm">
          <div style="font-weight:900">Add Vendor</div>
          <div class="small">Table/Dropdown shows 1st letter only</div>
        </div>
        <div class="sep"></div>
        <div class="itemGrid">
          <div>
            <div class="small">Vendor full name</div>
            <input id="setAddVendorName" class="input" placeholder="e.g., Mutual" />
          </div>
          <div>
            <div class="small">Initial (ex: MUT)</div>
            <input id="setAddVendorIni" class="input" placeholder="e.g., MUT" />
          </div>
          <div class="small" style="align-self:center">Auto-generate if blank</div>
          <div style="display:flex; justify-content:flex-end; align-items:end;">
            <button id="btnSettingsAddVendor" class="btn btn--primary" type="button">+ Add Vendor</button>
          </div>
        </div>
      </div>

      <div class="panel__header" style="margin-top:12px;">
        <div class="panel__title">Manage Vendors (Reorder / Edit / Lock / Delete)</div>
      </div>
      <div id="settingsVendorsManage" class="list"></div>

      <div class="panel__header" style="margin-top:12px;">
        <div class="panel__title">Manage Items (ALL items shown)</div>
      </div>
      <div id="settingsItemsManage" class="list"></div>
    </section>
  </main>

  <div id="toast" class="toast" aria-live="polite"></div>

  <script>














(() => {
  const APP_VERSION = "V6 2026-01-30 (PWA Final)";
  const STORAGE_KEY = "inventory_order_app_test";
  const QTY_STEPS = [0, 0.5, 1, 2, 3, 4, 5];
  const SEED_VENDORS = ["Mutual", "Nishimoto", "Resturant Depot", "H Mart", "Sam's Club", "Walmart"];
  const SEED_ITEMS = ["Tuna Blue fin", "Tuna Yellow Fin", "Ground Tuna", "Escolar", "Smoked Salmon", "Unagi", "Sushi Ebi", "Octopus", "Chashu", "Naruto Maki", "Green Mussel", "Ikura", "Tobiko(orange)", "Tamago", "Kani", "Mackerel", "Baby Scallop", "Ama Ebi", "Ika", "Hokkigai", "Snow Crab Leg", "Tsubugai", "Inari", "Scallop 3s", "Salmon", "Yellowtail", "Albacore Tuna", "Uni", "Madai", "Gyoza Veggi", "Gyoza Chicken", "Gyoza Pork", "Gyoza Beef", "Seaweed Salad", "Squid Salad", "Osaki Shred", "Soba Noodle", "Udon Noodle", "Ramen Noodle", "Pork Loin", "Chicken Breast", "Shrimp 21-25", "Shrimp 71-90 roll", "Nobashi Shirmp", "Soft Shell Crab", "Craw Fish", "Salmon Teriyaki 6oz", "Calamari", "Sushi Nori HalF", "Sushi Nori Full", "Soy Paper", "Shichimi", "Eel Sauce", "Sriracha", "Rayu", "Yuzu", "Tsuyu", "Ponzu Vinegar", "Japanese Dressing", "Yakisoba Sauce", "Tonkatsu Sauce", "Hondashi", "Katsuo Ïú°Ïàò", "Katsuo Îç∞ÏΩî", "Kizami(Îç∞ÏΩîÍπÄ)", "Furikake", "Wasabi", "Karrage Poweder", "Sweet Chilli Sauce", "Sesame Oil", "Sea Salt", "Black Pepper", "Cajun Powder", "Baking Spray", "Lemon Juice 1Gal", "Mayo", "Ïπ¥Î†à Í∞ÄÎ£®", "Mirim", "KD-39", "Shiragiku Vinegar", "Miso Soup Base", "Soy Sauce 5gal", "Light Soy Sauce 5gal", "Oil", "Sugar", "Salt", "Constachi", "Panko", "Tempurako", "Sushi Rice", "Edamame", "Shrimp Shumai", "Takoyaki", "Breaded Oyster", "Ika Geso", "Spring Roll", "Corn", "Avocado", "Onion", "Red Onion", "Sushi Ginger", "Cream Cheese", "Cucumber", "Green Onion", "Lemon", "Carrot", "Jalapeno", "Tonkotsu Ramen Base", "Miso Ramen Base", "Lettuce", "Broccoli", "Mushroom", "Egg", "Aquamar", "Kanpyo", "Yama Gobo", "Fukujin / Rakkyo", "Îã§ÏßÑ ÎßàÎäò", "Butter", "Magarin", "Food Plastic Film 12", "Food Plastic Film 18", "Wax Paper", "ÏùÄÎ∞ïÏßÄ 12X10.75", "Ïë§ÏÑ∏ÎØ∏", "Ï£ºÎ∞© ÎπÑÎãê Ïû•Í∞ë", "ÌîÑÎû© ÎπÑÎãêÎ∞± 6x3x15", "Toilet Paper", "Hand Tower", "Windex", "Dish Soap Pink", "Crolox/ÌôîÏû•Ïã§Ï≤≠ÏÜå Ïä§Ìã±", "Trash Bag 38-60", "Trash Bag 33-39", "Fabuloso", "Degreaser", "Hand Soap", "Bounty", "Sauce cup 2oz", "Raman Togo Box", "Bento Togo Box", "Sushi Togo Box A01", "Sushi Togo Box A02", "Sushi Togo Box A03", "Donburi Togo Box", "ÎØ∏ÏÜåÌà¨Í≥† 10oz", "Î¨º Ìà¨Í≥†Ïªµ 12oz", "Î¨º Ìà¨Í≥†Ïªµ 16oz", "ÏÉêÎü¨ÎìúÌà¨Í≥† Ìà¨Î™Ö 8oz", "ÌÅ∞Ìà¨Í≥†Î∞ïÏä§ 3Ïπ∏", "Ìà¨Í≥† ÌÅ∞Ïªµ 32oz", "Î∞• Ìà¨Í≥†Î∞ïÏä§", "Ïû•Ïñ¥ ÎçÆÎ∞• Ìà¨Í≥† RE-28", "Paper Bag #2", "Paper Bag #16", "Paper Bag #20", "Plastic Bag", "Togo Spoon", "Togo Fork", "Togo Knife", "Straw", "Napkin", "Chopstick", "Soy Sauce Packet", "Light Soy Packet", "Wakame (ÎØ∏ÏÜåÎØ∏Ïó≠)", "Sweet N Low", "Ramune Original", "Ramune Strawberry", "Ramune Grape", "Ramune Melon", "Calpico", "Calpico Soda", "Calpico Strawberry", "Calpico White peach", "Calpico Melon", "Calpico Mango", "Coke", "Diet Coke", "Zero Coke", "Sprite", "Fanta", "Dr.Pepper", "Root beer", "Toco Chico", "Perrier", "Bottle Water", "Fiji Water", "Milk", "Milk Choco", "Orange Juice", "Apple Juice", "Green Tea Bottle", "Jasmine Tea Bottle", "Green Tea", "Jasmine Tea", "Ice Tea", "ÍΩàÎ¶¨Í≥†Ï∂î", "Í≥†Íµ¨Îßà", "Ìò∏Î∞ï", "Î¨¥", "ÏÉùÍ∞ï", "ÏñëÎ∞∞Ï∂î", "Î∞∞Ï∂î", "ÎëêÎ∂Ä Red", "ÎëêÎ∂Ä Green", "Îã®Î¨¥ÏßÄ", "ÏÇ¨Í≥º", "Ïò§Î†åÏßÄ", "Î∂àÍ≥†Í∏∞", "Î∂àÍ≥†Í∏∞ ÏÜåÏä§", "ÎßåÎëêÌîº 5Í∞ú", "Î™©Ïû•Í∞ë", "Îã§ÏãúÎßà", "Î∂ÄÌÉÑÍ∞ÄÏä§", "ÏÑ∏ÎùºÎá®", "ÎùºÏù¥Ïä§ Ìå®Ïù¥Ìçº", "ÏïÑÏä§ÌååÎùºÍ±∞Ïä§", "ÎòêÎù†ÏïÑ", "Mango", "Ziplock", "Olive Oil (extra)", "Cheese Cake", "Cheese Cake Choco", "Cr√®me Brulee", "Mochi", "Oreo", "Sushi Glove S", "Sushi Glove M", "Bamboo Leaf", "Galic Flake", "Sake"];

  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const toastEl = document.getElementById("toast");
  const showToast = (msg) => {
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => (toastEl.style.display = "none"), 1400);
  };

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const mem = { value: null };
  const safeGet = () => { try { return localStorage.getItem(STORAGE_KEY); } catch { return mem.value; } };
  const safeSet = (v) => { try { localStorage.setItem(STORAGE_KEY, v); } catch { mem.value = v; } };

  
  // ----- Print window reuse (avoid opening many tabs) -----
  let __printWindow = null;
  function getPrintWindow(){
    try{ if(__printWindow && !__printWindow.closed) return __printWindow; }catch(e){}
    __printWindow = window.open('', 'order_list_print');
    return __printWindow;
  }
const escapeHtml = (s) => String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");

  function makeInitial(name) {
    const cleaned = String(name || "").trim();
    if (!cleaned) return "VEN";
    const upper = cleaned.toUpperCase();
    if (upper === "H MART") return "HM";
    if (upper.includes("RESTAUR") && upper.includes("DEPOT")) return "RD";
    if (upper.includes("SAM")) return "SAM";
    if (upper.includes("WALMART")) return "WAL";
    if (upper.includes("NISHIMOTO")) return "NIS";
    if (upper.includes("MUTUAL")) return "MUT";
    const parts = cleaned.split(/\s+/).filter(Boolean);
    let ini = parts.slice(0, 3).map(w => w[0]).join("").replace(/[^A-Z0-9]/gi, "");
    if (ini.length < 2) ini = cleaned.slice(0, 3);
    return (ini.toUpperCase().slice(0, 6) || "VEN");
  }

  function vendorShort(v) {
    const s = String(v?.initial || "").trim();
    if (s) return s[0].toUpperCase();
    const n = String(v?.name || "").trim();
    return n ? n[0].toUpperCase() : "‚Äî";
  }

  function defaultData() {
    const vendors = SEED_VENDORS.map((n, idx) => ({
      id: uid(),
      name: n,
      initial: makeInitial(n),
      sortOrder: idx + 1,
      locked: true
    }));
    const firstVendorId = vendors[0]?.id ?? null;

    const items = SEED_ITEMS.map((nm, idx) => ({
      id: uid(),
      name: String(nm).trim(),
      preferredVendorId: null,
      orderVendorId: null,
      qty: 0,
      sortOrder: idx + 1,
      locked: true
    }));

    return {
      meta: {
        version: APP_VERSION,
        createdAt: new Date().toISOString(),
        lastPreferredVendorId: firstVendorId,
        lastOrderVendorId: firstVendorId
      },
      vendors,
      items
    };
  }

  function normalize(parsed) {
    parsed = parsed || {};
    parsed.meta = parsed.meta || {};
    parsed.meta.version = APP_VERSION;
    parsed.vendors = Array.isArray(parsed.vendors) ? parsed.vendors : [];
    parsed.items = Array.isArray(parsed.items) ? parsed.items : [];

    parsed.vendors = parsed.vendors.map((v, idx) => ({
      id: v.id || uid(),
      name: String(v.name || "").trim(),
      initial: (String(v.initial || "").trim().toUpperCase().slice(0, 6) || makeInitial(v.name || "Vendor")),
      sortOrder: (typeof v.sortOrder === "number") ? v.sortOrder : (idx + 1),
      locked: (typeof v.locked === "boolean") ? v.locked : true
    })).filter(v => v.name);

    // remove legacy default vendors
    const removeNames = new Set(["sysco", "h-e-b", "us foods"]);
    const removedIds = new Set(parsed.vendors.filter(v => removeNames.has(v.name.toLowerCase())).map(v => v.id));
    parsed.vendors = parsed.vendors.filter(v => !removedIds.has(v.id));

    const firstVendorId = parsed.vendors[0]?.id ?? null;
    parsed.meta.lastPreferredVendorId = parsed.meta.lastPreferredVendorId ?? firstVendorId;
    parsed.meta.lastOrderVendorId = parsed.meta.lastOrderVendorId ?? firstVendorId;

    parsed.items = parsed.items.map((it, idx) => {
      const pv0 = it.preferredVendorId ?? null;
      const ov0 = it.orderVendorId ?? it.preferredVendorId ?? null;
      const pv = removedIds.has(pv0) ? null : pv0;
      const ov = removedIds.has(ov0) ? pv : ov0;
      return ({
        id: it.id || uid(),
        name: String(it.name || "").trim(),
        preferredVendorId: pv,
        orderVendorId: ov,
        qty: (typeof it.qty === "number") ? it.qty : 0,
        sortOrder: (typeof it.sortOrder === "number") ? it.sortOrder : (idx + 1),
        locked: (typeof it.locked === "boolean") ? it.locked : true
      });
    }).filter(it => it.name);

    if (parsed.vendors.length === 0) {
      const fresh = defaultData();
      parsed.vendors = fresh.vendors;
      parsed.meta.lastPreferredVendorId = fresh.meta.lastPreferredVendorId;
      parsed.meta.lastOrderVendorId = fresh.meta.lastOrderVendorId;
    }
    return parsed;
  }

  function loadOrCreate() {
    try {
      const raw = safeGet();
      if (!raw) return { data: defaultData(), existed: false };
      return { data: normalize(JSON.parse(raw)), existed: true };
    } catch (e) {
      console.error("Load error:", e);
      return { data: defaultData(), existed: false };
    }
  }

  let state = loadOrCreate().data;
  safeSet(JSON.stringify(state)); // ensure meta/version updated
  const save = () => safeSet(JSON.stringify(state));

  const vendorById = (id) => state.vendors.find(v => v.id === id) || null;
  const vendorLabel = (id) => vendorShort(vendorById(id));
  const vendorName = (id) => vendorById(id)?.name || "‚Äî";

  const clampQty = (q) => {
    let best = QTY_STEPS[0], bestD = Infinity;
    for (const s of QTY_STEPS) {
      const d = Math.abs(s - q);
      if (d < bestD) { bestD = d; best = s; }
    }
    return best;
  };

  function stepQty(current, dir) {
    const c = clampQty(Number(current) || 0);
    const idx = QTY_STEPS.findIndex(x => Number(x) === Number(c));
    const next = Math.max(0, Math.min(QTY_STEPS.length - 1, idx + dir));
    return QTY_STEPS[next];
  }

  function sortedVendors() {
    return [...state.vendors].sort((a,b)=>(a.sortOrder||0)-(b.sortOrder||0));
  }
  function sortedItems() {
    return [...state.items].sort((a,b)=>(a.sortOrder||0)-(b.sortOrder||0));
  }

  function vendorOptionsShort(selectedId) {
    const vendors = sortedVendors();
    if (vendors.length === 0) return '<option value="">(Add vendor first)</option>';
    const blank = '<option value="" ' + (!selectedId ? "selected" : "") + '>‚Äî</option>';
    return blank + vendors.map(v =>
      '<option value="' + v.id + '" ' + (v.id === selectedId ? "selected" : "") + '>' + escapeHtml(vendorShort(v)) + '</option>'
    ).join("");
  }

  // --- Item actions ---
  function setPreferredVendor(itemId, vendorId) {
    const it = state.items.find(i => i.id === itemId);
    if (!it) return;
    it.preferredVendorId = vendorId || null;
    if (!it.orderVendorId) it.orderVendorId = it.preferredVendorId;
    save();
  }
  function setOrderVendor(itemId, vendorId) {
    const it = state.items.find(i => i.id === itemId);
    if (!it) return;
    it.orderVendorId = vendorId || null;
    save();
  }
  function setQty(itemId, qty) {
    const it = state.items.find(i => i.id === itemId);
    if (!it) return;
    it.qty = clampQty(Number(qty));
    save();
  }
  function resetAllQty() {
    state.items.forEach(it => it.qty = 0);
    save();
  }
  function renameItem(itemId, name) {
    const it = state.items.find(i => i.id === itemId);
    if (!it) return;
    it.name = String(name||"").trim();
    save();
  }
  function toggleItemLock(itemId, locked) {
    const it = state.items.find(i => i.id === itemId);
    if (!it) return;
    it.locked = !!locked;
    save();
  }
  function moveItem(itemId, dir) {
    const s = sortedItems();
    const idx = s.findIndex(x=>x.id===itemId);
    const j = idx + dir;
    if (idx < 0 || j < 0 || j >= s.length) return;
    const a = s[idx], b = s[j];
    const ao = a.sortOrder||0, bo = b.sortOrder||0;
    state.items = state.items.map(it => it.id===a.id?{...it,sortOrder:bo}: it.id===b.id?{...it,sortOrder:ao}:it);
    save();
  }
  function deleteItem(itemId) {
    state.items = state.items.filter(it => it.id !== itemId);
    save();
  }

  // --- Vendor actions ---
  function addVendor(name, initial) {
    const n = String(name||"").trim();
    if (!n) return false;
    const ini = String(initial||"").trim().toUpperCase().slice(0,6) || makeInitial(n);
    const nextSort = Math.max(0, ...state.vendors.map(v=>v.sortOrder||0)) + 1;
    state.vendors.push({ id: uid(), name: n, initial: ini, sortOrder: nextSort, locked: true });
    if (!state.meta.lastPreferredVendorId) state.meta.lastPreferredVendorId = state.vendors[0]?.id ?? null;
    if (!state.meta.lastOrderVendorId) state.meta.lastOrderVendorId = state.vendors[0]?.id ?? null;
    save();
    return true;
  }
  function renameVendor(vendorId, name) {
    const v = vendorById(vendorId);
    if (!v) return;
    v.name = String(name||"").trim();
    save();
  }
  function setVendorInitial(vendorId, initial) {
    const v = vendorById(vendorId);
    if (!v) return;
    const ini = String(initial||"").trim().toUpperCase().slice(0,6);
    v.initial = ini || makeInitial(v.name);
    save();
  }
  function toggleVendorLock(vendorId, locked) {
    const v = vendorById(vendorId);
    if (!v) return;
    v.locked = !!locked;
    save();
  }
  function moveVendor(vendorId, dir) {
    const s = sortedVendors();
    const idx = s.findIndex(x=>x.id===vendorId);
    const j = idx + dir;
    if (idx < 0 || j < 0 || j >= s.length) return;
    const a = s[idx], b = s[j];
    const ao = a.sortOrder||0, bo = b.sortOrder||0;
    state.vendors = state.vendors.map(v => v.id===a.id?{...v,sortOrder:bo}: v.id===b.id?{...v,sortOrder:ao}:v);
    save();
  }
  function deleteVendor(vendorId) {
    state.vendors = state.vendors.filter(v => v.id !== vendorId);
    state.items = state.items.map(it => {
      const pv = it.preferredVendorId === vendorId ? null : it.preferredVendorId;
      const ov = it.orderVendorId === vendorId ? pv : it.orderVendorId;
      return { ...it, preferredVendorId: pv, orderVendorId: ov };
    });
    const first = state.vendors[0]?.id ?? null;
    if (state.meta.lastPreferredVendorId === vendorId) state.meta.lastPreferredVendorId = first;
    if (state.meta.lastOrderVendorId === vendorId) state.meta.lastOrderVendorId = first;
    save();
  }

  async function copyText(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch {}
    try {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      return true;
    } catch {
      return false;
    }
  }

  // ----- Orders grouping -----
  function groupedOrders() {
  const lines = state.items
    // View Orders shows ONLY items with Qty > 0
    .filter(it => ((it.qty || 0) > 0))
    .map(it => ({
      name: it.name,
      qty: clampQty(it.qty || 0),
      vendorId: it.orderVendorId || it.preferredVendorId || null
    }))
    .filter(x => x.vendorId);

  const map = new Map();
  for (const ln of lines) {
    if (!map.has(ln.vendorId)) map.set(ln.vendorId, []);
    map.get(ln.vendorId).push(ln);
  }

  const vendorIds = Array.from(map.keys()).sort((a,b)=>vendorLabel(a).localeCompare(vendorLabel(b)));
  return vendorIds.map(vid => ({
    vendorId: vid,
    vendorShort: vendorLabel(vid),
    vendorName: vendorName(vid),
    lines: map.get(vid).sort((a,b)=>a.name.localeCompare(b.name))
  }));
}

  function buildVendorCopyBlock(group) {
    return "[Vendor: " + group.vendorShort + "]\n" +
      group.lines.map(l => "- " + l.name + ": " + l.qty).join("\n") + "\n";
  }

  function openPrintWindow(groups, title) {
  const stamp = new Date().toLocaleString();
  const SCALE = 1.3; // +30%

  const blocks = groups.map(g => {
    const lines = g.lines.map(l => `<div class="i">${escapeHtml(l.name)} x ${escapeHtml(String(l.qty))}</div>`).join("");
    return `<div class="vblock"><div class="vname">${escapeHtml(g.vendorShort)}</div>${lines}</div>`;
  }).join("");

  const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${escapeHtml(title)}</title>
<style>
@page{margin:0.22in;}
html,body{padding:0;margin:0;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:#000;}
.hdr{font-size:20px;font-weight:900;margin:0 0 12px 0;}
.wrap{transform:scale(${SCALE});transform-origin:0 0;width:calc(100% / ${SCALE});}
.cols{column-count:2;column-gap:28px;column-fill:auto;}
.vblock{break-inside:avoid;page-break-inside:avoid;margin:0 0 24px 0;}
.vname{font-size:50px;font-weight:900;margin:0 0 12px 0;}
.i{font-size:39px;font-weight:700;line-height:1.18;margin:0 0 14px 0;}
</style>
</head>
<body onload="window.print()">
<div class="hdr">${escapeHtml(title)} ‚Ä¢ ${escapeHtml(stamp)}</div>
<div class="wrap"><div class="cols">${blocks}</div></div>
</body>
</html>`;

  const w = getPrintWindow();
  try{ w.focus(); }catch(e){}
  if (!w) { alert("Pop-up blocked. Please allow pop-ups for printing."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

  // ----- Tabs -----
  function goTab(name) {
    $$(".tab").forEach(b => b.classList.remove("is-active"));
    $$(".panel").forEach(p => p.classList.remove("is-active"));
    const btn = document.querySelector('.tab[data-tab="' + name + '"]');
    const panel = document.getElementById("tab-" + name);
    if (panel) {
      if (btn) btn.classList.add("is-active");
      panel.classList.add("is-active");
      renderAll();
    }
  }
  $$(".tab").forEach(btn => btn.addEventListener("click", () => goTab(btn.dataset.tab)));
  $("#btnGoOrders").addEventListener("click", () => goTab("orders"));
  $("#btnGoSettings").addEventListener("click", () => goTab("settings"));
  const _b1 = $("#btnBackHomeFromOrders"); if (_b1) _b1.addEventListener("click", () => goTab("items"));
  const _b2 = $("#btnBackHomeFromSettings"); if (_b2) _b2.addEventListener("click", () => goTab("items"));

  // Header actions
  const __btnExport = $("#btnExport");
  if (__btnExport) __btnExport.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "InventoryOrder_" + APP_VERSION.replace(/\s+/g, "_") + ".json";
    a.click();
    URL.revokeObjectURL(url);
    showToast("Exported");
  });

  const __fileImport = $("#fileImport");
  if (__fileImport) __fileImport.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      state = normalize(JSON.parse(text));
      save();
      renderAll();
      showToast("Imported");
    } catch (err) {
      alert("Import failed (JSON parse error).");
    } finally {
      e.target.value = "";
    }
  });

  const __btnReset = $("#btnReset");
  if (__btnReset) __btnReset.addEventListener("click", () => {
    const ok = confirm("Reset ALL data? This cannot be undone.");
    if (!ok) return;
    state = defaultData();
    save();
    renderAll();
    showToast("Reset done");
  });

  $("#btnResetQty").addEventListener("click", () => {
    const ok = confirm("Reset ALL quantities to 0?");
    if (!ok) return;
    resetAllQty();
    renderItems();
    renderOrders();
    showToast("Qty cleared");
  });

  // Orders print buttons
  $("#btnPrintAll").addEventListener("click", () => {
    const groups = groupedOrders();
    if (!groups.length) return;
    openPrintWindow(groups, "Order ‚Äî All Vendors");
  });
  $("#btnPrintSelected").addEventListener("click", () => {
    const groups = groupedOrders();
    if (!groups.length) return;
    const checked = Array.from(document.querySelectorAll('#vendorSelectBox input[type="checkbox"][data-vid]:checked'))
      .map(x => x.getAttribute("data-vid"));
    const selected = groups.filter(g => checked.includes(g.vendorId));
    if (!selected.length) { alert("No vendors selected."); return; }
    openPrintWindow(selected, "Order ‚Äî Selected Vendors");
  });

  // ----- Render: Items table -----
  function renderItems() {
    const el = $("#itemsList");
    const allSorted = sortedItems();
    state.meta = state.meta || {};
    const mode = state.meta.homeVendorFilterMode || "all";
    let filterVid = null;
    if (mode === "vendor") filterVid = state.meta.homeVendorFilterVendorId || null;

function matchesHomeVendorFilter(it, filterVid) {
  if (!filterVid) return true; // All
  // On Home: show item if it is assigned to this vendor (even when qty == 0)
  // Priority: orderVendorId, else preferredVendorId
  if (it.orderVendorId) return it.orderVendorId === filterVid;
  return (it.preferredVendorId || null) === filterVid;
}
    const sorted = filterVid ? allSorted.filter(it => {
      const vid = (it.orderVendorId ?? it.preferredVendorId ?? null);
      return vid === filterVid;
    }) : allSorted;

    renderHomeVendorQuick(allSorted);

    if (!sorted.length) {
      const hasAny = allSorted && allSorted.length;
      if (hasAny && (state.meta.homeVendorFilterVendorId || null)) {
        el.innerHTML = '<div class="card">No items for this vendor.</div>';
      } else {
        el.innerHTML = '<div class="card">No items yet. Go to <b>Settings</b> ‚Üí Add Item.</div>';
      }
      return;
    }

    const rows = sorted.map(it => {
      const prefId = it.preferredVendorId ?? null;
      const orderId = it.orderVendorId ?? prefId ?? null;
      const qty = clampQty(it.qty || 0);
      return (
        '<div class="itemRow" data-item="' + it.id + '">' +
          '<div class="cell colVendor"><select class="vendorSel" data-act="prefVendor">' + vendorOptionsShort(prefId) + '</select></div>' +
          '<div class="cell itemCell">' + escapeHtml(it.name) + '</div>' +
          '<div class="cell colVendor"><select class="vendorSel" data-act="orderVendor">' + vendorOptionsShort(orderId) + '</select></div>' +
          '<div class="cell colQty">' +
            '<div class="qtyCtl">' +
              '<button class="btn btn--ghost qtyBtn" data-act="qtyMinus" type="button">‚àí</button>' +
              '<div class="qtyVal" data-act="qtyVal">' + escapeHtml(String(qty)) + '</div>' +
              '<button class="btn btn--ghost qtyBtn" data-act="qtyPlus" type="button">+</button>' +
            '</div>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    el.innerHTML =
      '<div class="itemsGrid">' +
        '<div class="itemsHeader">' +
          '<div class="colVendor">Pref</div>' +
          '<div>Item</div>' +
          '<div class="colVendor">Order</div>' +
          '<div class="colQty" style="text-align:right;">Qty</div>' +
        '</div>' +
        rows +
      '</div>';


    el.querySelectorAll('.itemRow[data-item]').forEach(row => {
      const itemId = row.getAttribute("data-item");
      const prefSel = row.querySelector('select[data-act="prefVendor"]');
      const ordSel  = row.querySelector('select[data-act="orderVendor"]');
      const qtyVal  = row.querySelector('[data-act="qtyVal"]');
      const minus   = row.querySelector('button[data-act="qtyMinus"]');
      const plus    = row.querySelector('button[data-act="qtyPlus"]');

      prefSel.addEventListener("change", () => {
        setPreferredVendor(itemId, prefSel.value || null);
        renderOrders();
        showToast("Saved");
      });
      ordSel.addEventListener("change", () => {
        setOrderVendor(itemId, ordSel.value || null);
        renderOrders();
        showToast("Saved");
      });

      const updateQtyUI = (newQty) => { qtyVal.textContent = String(newQty); };

      minus.addEventListener("click", () => {
        const it = state.items.find(i => i.id === itemId);
        if (!it) return;
        const next = stepQty(it.qty, -1);
        setQty(itemId, next);
        updateQtyUI(next);
        renderOrders();
      });

      plus.addEventListener("click", () => {
        const it = state.items.find(i => i.id === itemId);
        if (!it) return;
        const next = stepQty(it.qty, +1);
        setQty(itemId, next);
        updateQtyUI(next);
        renderOrders();
      });
    });
  }

  // ----- Render: Orders -----
  function renderHomeVendorQuick(allItemsSorted) {
  const box = $("#homeVendorQuick");
  if (!box) return;
  state.meta = state.meta || {};

  // Default: All
  if (!state.meta.homeVendorFilterMode) state.meta.homeVendorFilterMode = "all";

  // Count ALL items assigned to a vendor (orderVendorId first, else preferredVendorId)
  const counts = {};
  (allItemsSorted || []).forEach(it => {
    const vid = (it.orderVendorId ?? it.preferredVendorId ?? null);
    if (!vid) return;
    counts[vid] = (counts[vid] || 0) + 1;
  });

  const vendors = sortedVendors();
  const allCount = Object.values(counts).reduce((a,b)=>a+b,0);
  const chips = [{ id: null, label: "All", count: allCount }];

  vendors.forEach(v => {
    const c = counts[v.id] || 0;
    if (c > 0) chips.push({ id: v.id, label: vendorShort(v), count: c });
  });

  const mode = state.meta.homeVendorFilterMode || "all";
  const selectedVid = (mode === "vendor") ? (state.meta.homeVendorFilterVendorId || null) : null;

  box.innerHTML = chips.map(ch => {
    const isActive = (ch.id === null && mode === "all") || (ch.id !== null && mode === "vendor" && ch.id === selectedVid);
    return (
      '<button type="button" class="chip' + (isActive ? ' active' : '') +
      '" data-vid="' + (ch.id||"") + '">' +
        escapeHtml(ch.label) + '<small>' + ch.count + '</small>' +
      '</button>'
    );
  }).join("");

  box.querySelectorAll('button[data-vid]').forEach(btn => {
    btn.onclick = () => {
      const vid = btn.getAttribute("data-vid") || "";
      if (!vid) {
        state.meta.homeVendorFilterMode = "all";
        state.meta.homeVendorFilterVendorId = null;
      } else {
        state.meta.homeVendorFilterMode = "vendor";
        state.meta.homeVendorFilterVendorId = vid;
      }
      save();
      renderItems();
    };
  });
}

function renderOrders() {
    const selectBox = $("#vendorSelectBox");
    const view = $("#ordersView");
    const groups = groupedOrders();

    if (!groups.length) {
      selectBox.innerHTML = '<div class="small">No items with Qty > 0 yet.</div>';
      view.innerHTML = '<div class="card">Set quantities on Home, then orders will appear here grouped by vendor.</div>';
      return;
    }

    selectBox.innerHTML = groups.map(g =>
      '<label class="check">' +
        '<input type="checkbox" data-vid="' + g.vendorId + '" checked />' +
        '<span><b>' + escapeHtml(g.vendorShort) + '</b></span>' +
      '</label>'
    ).join("");

    view.innerHTML = groups.map(g => {
      const lines = g.lines.map(l =>
        '<div class="orderLine"><div class="name">' + escapeHtml(l.name) + '</div><div class="qty">' + escapeHtml(String(l.qty)) + '</div></div>'
      ).join("");
      return (
        '<div class="card">' +
          '<div class="vendorCard__head">' +
            '<div class="vendorTitle">' +
              '<div class="big">Vendor: ' + escapeHtml(g.vendorShort) + '</div>' +
              '<div class="sub">' + escapeHtml(g.vendorName) + '</div>' +
            '</div>' +
            '<div class="pill">' +
              '<button class="btn btn--ghost" data-act="copyVendor" data-vid="' + g.vendorId + '" type="button">Copy</button>' +
              '<button class="btn btn--primary" data-act="printVendor" data-vid="' + g.vendorId + '" type="button">Print</button>' +
            '</div>' +
          '</div>' +
          '<div class="orderList">' + lines + '</div>' +
        '</div>'
      );
    }).join("");

    view.querySelectorAll('button[data-act="copyVendor"]').forEach(btn => {
      btn.addEventListener("click", async () => {
        const vid = btn.getAttribute("data-vid");
        const g = groups.find(x => x.vendorId === vid);
        if (!g) return;
        const ok = await copyText(buildVendorCopyBlock(g));
        showToast(ok ? "Copied" : "Copy failed");
      });
    });

    view.querySelectorAll('button[data-act="printVendor"]').forEach(btn => {
      btn.addEventListener("click", () => {
        const vid = btn.getAttribute("data-vid");
        const g = groups.find(x => x.vendorId === vid);
        if (!g) return;
        openPrintWindow([g], "Order ‚Äî " + g.vendorShort);
      });
    });
  }

  // ----- Render: Vendors view -----
  function renderVendors() {
    const el = $("#vendorsListView");
    if (!el) return;
    const vendors = sortedVendors();
    if (!vendors.length) {
      el.innerHTML = '<div class="card">No vendors. Add vendors in <b>Settings</b>.</div>';
      return;
    }
    el.innerHTML = vendors.map(v =>
      '<div class="card"><div class="row between wrap gap-sm"><div class="pill">' +
        '<span class="badge badge--ok">' + escapeHtml(v.initial) + '</span>' +
        '<span style="font-weight:900">' + escapeHtml(v.name) + '</span>' +
      '</div></div></div>'
    ).join("");
  }

  // ----- Render: Settings -----
  function renderSettings() {
    state.meta = state.meta || {};
    const first = sortedVendors()[0]?.id ?? null;
    if (!state.meta.lastPreferredVendorId) state.meta.lastPreferredVendorId = first;
    if (!state.meta.lastOrderVendorId) state.meta.lastOrderVendorId = first;

    // Add item form
    const prefSel = $("#setAddPrefVendor");
    const ordSel  = $("#setAddOrderVendor");
    const nameInp = $("#setAddItemName");

    prefSel.innerHTML = vendorOptionsShort(state.meta.lastPreferredVendorId);
    ordSel.innerHTML  = vendorOptionsShort(state.meta.lastOrderVendorId);

    prefSel.onchange = () => { state.meta.lastPreferredVendorId = prefSel.value || null; save(); };
    ordSel.onchange  = () => { state.meta.lastOrderVendorId = ordSel.value || null; save(); };

    $("#btnSettingsAddItem").onclick = () => {
      const nm = String(nameInp.value || "").trim();
      if (!nm) { alert("Item name required."); return; }
      const nextSort = Math.max(0, ...state.items.map(i => i.sortOrder || 0)) + 1;

      const pv = prefSel.value || state.meta.lastPreferredVendorId || null;
      const ov = ordSel.value || state.meta.lastOrderVendorId || pv || null;

      state.items.push({
        id: uid(),
        name: nm,
        preferredVendorId: pv,
        orderVendorId: ov,
        qty: 0,
        sortOrder: nextSort,
        locked: true
      });

      state.meta.lastPreferredVendorId = pv;
      state.meta.lastOrderVendorId = ov;
      save();

      nameInp.value = "";
      renderAll();
      showToast("Item added");
    };

    // Add vendor form
    const vName = $("#setAddVendorName");
    const vIni  = $("#setAddVendorIni");
    $("#btnSettingsAddVendor").onclick = () => {
      const ok = addVendor(vName.value, vIni.value);
      if (!ok) { alert("Vendor name required."); return; }
      vName.value = ""; vIni.value = "";
      renderAll();
      showToast("Vendor added");
    };

    // Manage vendors (reorder/edit/lock/delete)
    const vBox = $("#settingsVendorsManage");
    const vendors = sortedVendors();
    vBox.innerHTML = vendors.length ? vendors.map(v =>
      '<div class="card" data-mvendor="' + v.id + '">' +
        '<div class="row between wrap gap-sm">' +
          '<div class="pill"><span class="badge badge--ok">' + escapeHtml(v.initial) + '</span> <span style="font-weight:900">' + escapeHtml(v.name) + '</span></div>' +
          '<div class="smallBtnRow">' +
            '<button class="btn iconBtn" data-act="vUp" type="button" ' + (v.locked ? 'disabled' : '') + '>‚¨ÜÔ∏è</button>' +
            '<button class="btn iconBtn" data-act="vDown" type="button" ' + (v.locked ? 'disabled' : '') + '>‚¨áÔ∏è</button>' +
            '<button class="btn btn--danger" data-act="vDel" type="button" ' + (v.locked ? 'disabled' : '') + '>Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="sep"></div>' +
        '<div class="itemGrid">' +
          '<div><div class="small">Vendor name</div><input class="input" data-act="vName" value="' + escapeHtml(v.name) + '" ' + (v.locked ? "disabled" : "") + ' /></div>' +
          '<div><div class="small">Initial (ex: MUT)</div><input class="input" data-act="vIni" value="' + escapeHtml(v.initial) + '" ' + (v.locked ? "disabled" : "") + ' /></div>' +
          '<div style="display:flex;align-items:end"><label class="lockTag"><input type="checkbox" data-act="vLock" ' + (v.locked ? "checked" : "") + ' />Lock (edit/delete)</label></div>' +
          '<div class="small" style="align-self:center">Table/Dropdown shows 1st letter only</div>' +
        '</div>' +
      '</div>'
    ).join("") : '<div class="card">No vendors yet.</div>';

    vBox.querySelectorAll('[data-mvendor]').forEach(card => {
      const vid = card.getAttribute('data-mvendor');
      card.querySelector('[data-act="vUp"]').onclick = () => { const v = vendorById(vid); if (v?.locked) { alert("Locked. Uncheck Lock to reorder."); return; } moveVendor(vid, -1); renderAll(); };
      card.querySelector('[data-act="vDown"]').onclick = () => { const v = vendorById(vid); if (v?.locked) { alert("Locked. Uncheck Lock to reorder."); return; } moveVendor(vid, +1); renderAll(); };

      const nameI = card.querySelector('input[data-act="vName"]');
      const iniI  = card.querySelector('input[data-act="vIni"]');
      const lockC = card.querySelector('input[data-act="vLock"]');

      nameI.onchange = () => { renameVendor(vid, nameI.value); renderAll(); showToast("Saved"); };
      iniI.onchange = () => { setVendorInitial(vid, iniI.value); renderAll(); showToast("Saved"); };
      lockC.onchange = () => { toggleVendorLock(vid, lockC.checked); renderAll(); showToast("Saved"); };

      card.querySelector('[data-act="vDel"]').onclick = () => {
        const v = vendorById(vid);
        if (!v) return;
        if (v.locked) { alert("Lock (edit/delete)is locked. Unlock it to edit/delete."); return; }
        const ok = confirm('Delete vendor "' + (v.name || '') + '"? (Items using it will be cleared)');
        if (!ok) return;
        deleteVendor(vid);
        renderAll();
        showToast("Vendor deleted");
      };
    });

    // Manage items (reorder/edit/lock/delete) - SHOW ALL
    const itemsBox = $("#settingsItemsManage");
    const items = sortedItems();
    itemsBox.innerHTML = items.length ? items.map(it =>
      '<div class="card" data-mitem="' + it.id + '">' +
        '<div class="row between wrap gap-sm">' +
          '<div class="pill"><span class="badge badge--primary">ITEM</span> <span class="small">' + escapeHtml(it.name) + '</span></div>' +
          '<div class="smallBtnRow">' +
            '<button class="btn iconBtn" data-act="iUp" type="button" ' + (it.locked ? 'disabled' : '') + '>‚¨ÜÔ∏è</button>' +
            '<button class="btn iconBtn" data-act="iDown" type="button" ' + (it.locked ? 'disabled' : '') + '>‚¨áÔ∏è</button>' +
            '<button class="btn btn--danger" data-act="iDel" type="button" ' + (it.locked ? 'disabled' : '') + '>Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="sep"></div>' +
        '<div class="itemGrid">' +
          '<div><div class="small">Item name</div><input class="input" data-act="iName" value="' + escapeHtml(it.name) + '" ' + (it.locked ? "disabled" : "") + ' /></div>' +
          '<div><div class="small">Preferred (1 letter)</div><select data-act="iPref" ' + (it.locked ? "disabled" : "") + '>' + vendorOptionsShort(it.preferredVendorId) + '</select></div>' +
          '<div><div class="small">Order (1 letter)</div><select data-act="iOrder" ' + (it.locked ? "disabled" : "") + '>' + vendorOptionsShort(it.orderVendorId) + '</select></div>' +
          '<div style="display:flex;align-items:end"><label class="lockTag"><input type="checkbox" data-act="iLock" ' + (it.locked ? "checked" : "") + ' />Lock (edit/delete)</label></div>' +
        '</div>' +
      '</div>'
    ).join("") : '<div class="card">No items yet.</div>';

    itemsBox.querySelectorAll('[data-mitem]').forEach(card => {
      const itemId = card.getAttribute('data-mitem');

      card.querySelector('[data-act="iUp"]').onclick = () => { const it = itemById(itemId); if (it?.locked) { alert("Locked. Uncheck Lock to reorder."); return; } moveItem(itemId, -1); renderAll(); };
      card.querySelector('[data-act="iDown"]').onclick = () => { const it = itemById(itemId); if (it?.locked) { alert("Locked. Uncheck Lock to reorder."); return; } moveItem(itemId, +1); renderAll(); };

      const nameI = card.querySelector('input[data-act="iName"]');
      const prefS = card.querySelector('select[data-act="iPref"]');
      const ordS  = card.querySelector('select[data-act="iOrder"]');
      const lockC = card.querySelector('input[data-act="iLock"]');

      nameI.onchange = () => { renameItem(itemId, nameI.value); renderAll(); showToast("Saved"); };
      prefS.onchange = () => { setPreferredVendor(itemId, prefS.value||null); renderAll(); showToast("Saved"); };
      ordS.onchange  = () => { setOrderVendor(itemId, ordS.value||null); renderAll(); showToast("Saved"); };
      lockC.onchange = () => { toggleItemLock(itemId, lockC.checked); renderAll(); showToast("Saved"); };

      card.querySelector('[data-act="iDel"]').onclick = () => {
        const it = state.items.find(x=>x.id===itemId);
        if (!it) return;
        if (it.locked) { alert("Lock (edit/delete)is locked. Unlock it to edit/delete."); return; }
        const ok = confirm("Delete this item?");
        if (!ok) return;
        deleteItem(itemId);
        renderAll();
        showToast("Item deleted");
      };
    });
  }

  function renderAll() {
    renderItems();
    renderOrders();
    renderVendors();
    renderSettings();
  }

  renderAll();


  // ----- V14 Overrides: simpler Orders display + clean 2-column print -----
  function buildVendorCopyBlock(group) {
    return group.vendorShort + "\n" +
      group.lines.map(l => l.name + " x " + l.qty).join("\n") + "\n";
  }

  function openPrintWindow(groups, title) {
    const stamp = new Date().toLocaleString();
    const bodyHtml = groups.map(g => {
      const lines = g.lines.map(l =>
        '<div class="it">' + escapeHtml(l.name) + ' x ' + escapeHtml(String(l.qty)) + '</div>'
      ).join("");
      return (
        '<div class="vendor">' +
          '<div class="v">' + escapeHtml(g.vendorShort) + '</div>' +
          lines +
        '</div>'
      );
    }).join("");

    const html =
'<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>' +
'<title>' + escapeHtml(title) + '</title>' +
'<style>' +
'@page{margin:0.4in;}' +
'html,body{margin:0;padding:0;}' +
'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;color:#000;}' +
'.hdr{font-size:12px;font-weight:700;margin:0 0 8px 0;}' +
'.cols{column-count:2;column-gap:22px;}' +
'.vendor{break-inside:avoid;page-break-inside:avoid;margin:0 0 10px 0;}' +
'.v{font-size:14px;font-weight:900;margin:0 0 4px 0;}' +
'.it{font-size:12px;line-height:1.25;margin:0 0 2px 0;}' +
'</style></head>' +
'<body onload="window.print()">' +
'<div class="hdr">' + escapeHtml(title) + ' ‚Ä¢ ' + escapeHtml(stamp) + '</div>' +
'<div class="cols">' + bodyHtml + '</div>' +
'</body></html>';

    const w = getPrintWindow();
  try{ w.focus(); }catch(e){}
    if (!w) { alert("Pop-up blocked. Please allow pop-ups for printing."); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function renderOrders() {
    const selectBox = $("#vendorSelectBox");
    const view = $("#ordersView");
    const groups = groupedOrders();

    if (!groups.length) {
      selectBox.innerHTML = '<div class="small">No items with Qty &gt; 0 yet.</div>';
      view.innerHTML = '<div class="card">ItemsWhen you set quantities on Home, they will appear here grouped by vendor.</div>';
      return;
    }

    selectBox.innerHTML = groups.map(g =>
      '<label class="check">' +
        '<input type="checkbox" data-vid="' + g.vendorId + '" checked />' +
        '<span><b>' + escapeHtml(g.vendorShort) + '</b></span>' +
      '</label>'
    ).join("");

    view.innerHTML = groups.map(g => {
      const lines = g.lines.map(l =>
        '<div class="orderLine"><div class="name">' +
          escapeHtml(l.name) + ' x ' + escapeHtml(String(l.qty)) +
        '</div></div>'
      ).join("");
      return (
        '<div class="card">' +
          '<div class="vendorCard__head">' +
            '<div class="vendorTitle">' +
              '<div class="big">' + escapeHtml(g.vendorShort) + '</div>' +
            '</div>' +
            '<div class="pill">' +
              '<button class="btn btn--ghost" data-act="copyVendor" data-vid="' + g.vendorId + '" type="button">Copy</button>' +
              '<button class="btn btn--primary" data-act="printVendor" data-vid="' + g.vendorId + '" type="button">Print</button>' +
            '</div>' +
          '</div>' +
          '<div class="orderList">' + lines + '</div>' +
        '</div>'
      );
    }).join("");

    view.querySelectorAll('button[data-act="copyVendor"]').forEach(btn => {
      btn.addEventListener("click", async () => {
        const vid = btn.getAttribute("data-vid");
        const g = groups.find(x => x.vendorId === vid);
        if (!g) return;
        const ok = await copyText(buildVendorCopyBlock(g));
        showToast(ok ? "Copied" : "Copy failed");
      });
    });

    view.querySelectorAll('button[data-act="printVendor"]').forEach(btn => {
      btn.addEventListener("click", () => {
        const vid = btn.getAttribute("data-vid");
        const g = groups.find(x => x.vendorId === vid);
        if (!g) return;
        openPrintWindow([g], "Order ‚Äî " + g.vendorShort);
      });
    });
  }
  // ----- end V14 overrides -----

})();














  </script>

<script>
  // PWA service worker (HTTPS or localhost required)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    });
  }
</script>
</body>
</html>
